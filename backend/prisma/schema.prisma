generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

model User {
  id                     String         @id @default(uuid())
  email                  String         @unique
  password               String
  name                   String?
  role                   Role           @default(USER)
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  isEmailVerified        Boolean        @default(false)
  emailVerificationToken String?        @unique
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  refreshTokens          RefreshToken[]
  stripeCustomerId       String?        @unique @map("stripe_customer_id")
  subscription           Subscription?
  Payments               Payments[]
}

model RefreshToken {
  id          String   @id @default(uuid())
  hashedToken String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Product {
  id              String   @id @default(uuid())
  name            String
  description     String?
  stripeProductId String   @unique @map("stripe_product_id")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  plans           Plan[]
}

model Plan {
  id            String         @id @default(cuid())
  name          String
  price         Float
  currency      String         @default("inr")
  interval      String         @default("month")
  stripePriceId String         @unique @map("stripe_price_id")
  features      String[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  active        Boolean        @default(true)
  product       Product?       @relation(fields: [productId], references: [id])
  productId     String?
  subscriptions Subscription[]

  @@index([productId])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  PAST_DUE
}

model Subscription {
  id String @id @default(cuid())
  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  status               SubscriptionStatus
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  canceledAt           DateTime?

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  plan   Plan   @relation(fields: [planId], references: [id])
  planId String

  @@index([userId])
  @@index([stripeSubscriptionId])
}

model Payments {
  id                    String   @id @default(uuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripePaymentIntentId String   @unique
  stripeInvoiceId       String?
  amount                Int
  currency              String   @default("inr")
  status                String
  description           String?
  recipientUrl          String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}
